{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 13, "column": 0}, "map": {"version":3,"sources":["file:///Users/wanga/Desktop/cookie/frontend/src/utils/api.ts"],"sourcesContent":["/**\n * Safely construct API URLs by ensuring no double slashes\n */\nexport function getApiUrl(): string {\n  const baseUrl = process.env.NEXT_PUBLIC_API_URL || \"http://localhost:3001\";\n  // Remove trailing slash if present\n  return baseUrl.replace(/\\/$/, \"\");\n}\n\n/**\n * Construct full API endpoint URL\n */\nexport function getApiEndpoint(path: string): string {\n  const baseUrl = getApiUrl();\n  // Ensure path starts with /\n  const cleanPath = path.startsWith(\"/\") ? path : `/${path}`;\n  return `${baseUrl}${cleanPath}`;\n}\n"],"names":[],"mappings":"AAAA;;CAEC;;;;AACM,SAAS;IACd,MAAM,UAAU,QAAQ,GAAG,CAAC,mBAAmB,IAAI;IACnD,mCAAmC;IACnC,OAAO,QAAQ,OAAO,CAAC,OAAO;AAChC;AAKO,SAAS,eAAe,IAAY;IACzC,MAAM,UAAU;IAChB,4BAA4B;IAC5B,MAAM,YAAY,KAAK,UAAU,CAAC,OAAO,OAAO,CAAC,CAAC,EAAE,MAAM;IAC1D,OAAO,GAAG,UAAU,WAAW;AACjC","debugId":null}},
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///Users/wanga/Desktop/cookie/frontend/src/context/CountdownContext.tsx"],"sourcesContent":["\"use client\";\n\nimport React, { createContext, useContext, useEffect, useState } from \"react\";\nimport { getApiEndpoint } from \"@/utils/api\";\n\nconst FREEZE_SEC = Number(process.env.NEXT_PUBLIC_FREEZE_SEC || 180);\nconst WINNER_HOLD_MS = Number(process.env.NEXT_PUBLIC_WINNER_HOLD_MS || 15000);\n\ninterface DrawInfo {\n  hasActiveDraw: boolean;\n  round?: number;\n  drawTime?: number; // UNIX seconds: round end\n  freezeTime?: number; // UNIX seconds: end - FREEZE_SEC\n  secondsRemaining?: number;\n  totalEntries?: number;\n  automationEnabled?: boolean;\n  isFrozen?: boolean;\n  isCompleted?: boolean; // optional\n  message?: string;\n  drawNumber?: number; // Added for unified endpoint\n  roundState?: {\n    // Added for unified endpoint\n    isActive: boolean;\n    start: number;\n    end: number;\n    winner: string;\n    winningTokenId: string;\n  } | null;\n}\n\ninterface CountdownContextType {\n  timeLeft: string;\n  loading: boolean;\n  error: string;\n  drawInfo: DrawInfo | null;\n}\n\nconst CountdownContext = createContext<CountdownContextType | undefined>(\n  undefined\n);\n\nexport const CountdownProvider: React.FC<{ children: React.ReactNode }> = ({\n  children,\n}) => {\n  const [timeLeft, setTimeLeft] = useState(\"\");\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(\"\");\n  const [drawInfo, setDrawInfo] = useState<DrawInfo | null>(null);\n\n  const fetchDrawInfo = async (): Promise<DrawInfo | null> => {\n    try {\n      if (typeof window === \"undefined\") return null;\n      // ✅ NEW: Use unified endpoint for better synchronization\n      const endpoint = getApiEndpoint(\"/api/automation/unified-status\");\n\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 10000);\n\n      const res = await fetch(endpoint, {\n        method: \"GET\",\n        mode: \"cors\",\n        cache: \"no-store\",\n        signal: controller.signal,\n        headers: {\n          Accept: \"application/json\",\n          \"Content-Type\": \"application/json\",\n        },\n      });\n\n      clearTimeout(timeoutId);\n      if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);\n\n      const json = await res.json();\n      if (!json?.success) throw new Error(json?.error || \"API unsuccessful\");\n\n      // ✅ NEW: Transform unified response to DrawInfo format\n      const unifiedData = json.data;\n      const automation = unifiedData.automation;\n      const roundData = unifiedData.roundData;\n\n      // Convert to DrawInfo format for compatibility\n      const drawInfo: DrawInfo = {\n        drawNumber: unifiedData.drawNumber || 1,\n        hasActiveDraw: automation?.hasActiveDraw || false,\n        drawTime: automation?.drawTime || null,\n        freezeTime: automation?.freezeTime || null,\n        totalEntries: automation?.totalEntries || 0,\n        isCompleted: automation?.isCompleted || false,\n        round: automation?.round || unifiedData.currentRound || 0,\n\n        // Additional automation-specific data\n        automationEnabled: automation?.isEnabled || false,\n        roundState: roundData\n          ? {\n              isActive: roundData.isActive,\n              start: roundData.start,\n              end: roundData.end,\n              winner: roundData.winner,\n              winningTokenId: roundData.winningTokenId,\n            }\n          : null,\n      };\n\n      return drawInfo;\n    } catch (err) {\n      console.error(\"❌ Error fetching unified draw info:\", err);\n      return null;\n    }\n  };\n\n  useEffect(() => {\n    let lastFetchTime = 0;\n    let cached: DrawInfo | null = null;\n    let winnerHoldUntil = 0; // hold “Winner chosen!” briefly after completion\n\n    const fetchData = async () => {\n      const d = await fetchDrawInfo();\n      if (!d) {\n        setError(\"Please wait\");\n        setLoading(false);\n        return;\n      }\n      cached = d;\n      setDrawInfo(d);\n      setError(\"\");\n      setLoading(false);\n      lastFetchTime = Date.now();\n\n      if (d.isCompleted) {\n        winnerHoldUntil = Date.now() + WINNER_HOLD_MS;\n      }\n    };\n\n    const fmt = (sec: number) => {\n      const h = Math.floor(sec / 3600);\n      const m = Math.floor((sec % 3600) / 60);\n      const s = sec % 60;\n      return `${String(h).padStart(2, \"0\")}:${String(m).padStart(\n        2,\n        \"0\"\n      )}:${String(s).padStart(2, \"0\")}`;\n    };\n\n    const updateCountdown = () => {\n      if (!cached) {\n        setTimeLeft(\"Loading...\");\n        return;\n      }\n\n      // Keep “Winner chosen!” visible even if next round already started\n      if (winnerHoldUntil > Date.now()) {\n        setTimeLeft(\"Winner chosen!\");\n        return;\n      }\n\n      const now = Math.floor(Date.now() / 1000);\n\n      // No active draw yet\n      if (!cached.hasActiveDraw) {\n        setTimeLeft(\"Round starting\");\n        return;\n      }\n\n      const end = cached.drawTime ?? 0;\n      const freezeAt = cached.freezeTime ?? (end ? end - FREEZE_SEC : 0);\n      const secsToFreeze = Math.max(0, freezeAt > 0 ? freezeAt - now : 0);\n      const secsToEnd = Math.max(0, end > 0 ? end - now : 0);\n\n      // After end → Automation/VRF\n      if (end > 0 && now >= end) {\n        if (cached.isCompleted) {\n          setTimeLeft(\"Winner chosen!\");\n          if (winnerHoldUntil === 0) {\n            winnerHoldUntil = Date.now() + WINNER_HOLD_MS;\n          }\n        } else {\n          setTimeLeft(\"awaiting winner...\");\n        }\n        if (Date.now() - lastFetchTime > 2000) void fetchData();\n        return;\n      }\n\n      // Freeze window\n      if (freezeAt > 0 && now >= freezeAt && now < end) {\n        setTimeLeft(\"drawing...\");\n        return;\n      }\n\n      // Pre-freeze countdown\n      if (end > 0 && now < freezeAt) {\n        setTimeLeft(fmt(secsToFreeze)); // mm:ss\n        return;\n      }\n\n      // Fallback\n      setTimeLeft(secsToEnd > 0 ? fmt(secsToEnd) : \"Round pending\");\n    };\n\n    void fetchData();\n    const dataFetchInterval = setInterval(fetchData, 30_000);\n    const countdownInterval = setInterval(updateCountdown, 1000);\n\n    return () => {\n      clearInterval(dataFetchInterval);\n      clearInterval(countdownInterval);\n    };\n  }, []);\n\n  return (\n    <CountdownContext.Provider value={{ timeLeft, loading, error, drawInfo }}>\n      {children}\n    </CountdownContext.Provider>\n  );\n};\n\nexport const useCountdown = (): CountdownContextType => {\n  const ctx = useContext(CountdownContext);\n  if (!ctx)\n    throw new Error(\"useCountdown must be used within a CountdownProvider\");\n  return ctx;\n};\n"],"names":[],"mappings":"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","debugId":null}}]
}